#!/bin/sh

LANG=C
export LANG

if [ $# -ne 1 ]; then
  echo "Usage : $0 <version>"
  exit 2
fi

version=$1
subdir=chrony-${version}
mandate=$(date +'%B %Y')

umask 022

if [ ! -d .git ]; then
  echo "No .git subdirectory?"
  exit 3
fi

[ -d RELEASES ] || mkdir RELEASES

git tag -s $version || exit 1

rm -rf RELEASES/$subdir

git archive --format=tar --prefix=RELEASES/${subdir}/ $version | \
  tar xf - || exit 1

cd RELEASES/$subdir || exit 1

echo $version > version.txt

sed -e "s%@@VERSION@@%${version}%" < chrony.spec.sample > chrony.spec

for m in chrony.1 chronyc.1 chrony.conf.5 chronyd.8; do
  sed -e "s%@VERSION@%${version}%;s%@MAN_DATE@%${mandate}%" \
    < $m > ${m}_
  mv -f ${m}_ $m
done

makeinfo --no-headers --number-sections -o chrony.txt chrony.texi

rm -f make_release chrony.spec.sample .gitignore

cd ..
tar cvf - $subdir | gzip -9 > ${subdir}.tar.gz
gpg -b -a -o ${subdir}-tar-gz-asc.txt ${subdir}.tar.gz


